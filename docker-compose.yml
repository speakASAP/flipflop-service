services:
  frontend:
    build:
      context: .
      dockerfile: ./services/frontend/Dockerfile
    container_name: e-commerce-frontend
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"
    depends_on:
      - api-gateway
    volumes:
      - ./logs:/app/logs
      - ./services/frontend:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${FRONTEND_PORT:-3000}
      - NEXT_PUBLIC_API_URL=${API_URL:-http://localhost:3001}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${FRONTEND_PORT:-3000}"]
      interval: 30s
      timeout: 10s
      retries: 5

  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
    container_name: e-commerce-api-gateway
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${API_GATEWAY_PORT:-3001}:${API_GATEWAY_PORT:-3001}"
    depends_on:
      - user-service
      - product-service
      - order-service
      - supplier-service
    volumes:
      - ./logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${API_GATEWAY_PORT:-3001}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_GATEWAY_PORT:-3001}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  user-service:
    build:
      context: .
      dockerfile: ./services/user-service/Dockerfile
    container_name: e-commerce-user-service
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${USER_SERVICE_PORT:-3004}:${USER_SERVICE_PORT:-3004}"
    volumes:
      - ./logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${USER_SERVICE_PORT:-3004}
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-ecommerce}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${USER_SERVICE_PORT:-3004}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  product-service:
    build:
      context: .
      dockerfile: ./services/product-service/Dockerfile
    container_name: e-commerce-product-service
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${PRODUCT_SERVICE_PORT:-3002}:${PRODUCT_SERVICE_PORT:-3002}"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${PRODUCT_SERVICE_PORT:-3002}
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-ecommerce}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PRODUCT_SERVICE_PORT:-3002}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  order-service:
    build:
      context: .
      dockerfile: ./services/order-service/Dockerfile
    container_name: e-commerce-order-service
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${ORDER_SERVICE_PORT:-3003}:${ORDER_SERVICE_PORT:-3003}"
    volumes:
      - ./logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${ORDER_SERVICE_PORT:-3003}
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-ecommerce}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${ORDER_SERVICE_PORT:-3003}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  supplier-service:
    build:
      context: .
      dockerfile: ./services/supplier-service/Dockerfile
    container_name: e-commerce-supplier-service
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${SUPPLIER_SERVICE_PORT:-3006}:${SUPPLIER_SERVICE_PORT:-3006}"
    volumes:
      - ./logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${SUPPLIER_SERVICE_PORT:-3006}
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-ecommerce}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${SUPPLIER_SERVICE_PORT:-3006}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  ai-service:
    build:
      context: .
      dockerfile: ./services/ai-service/Dockerfile
    container_name: e-commerce-ai-service
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${AI_SERVICE_PORT:-3007}:${AI_SERVICE_PORT:-3007}"
    volumes:
      - ./logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${AI_SERVICE_PORT:-3007}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${AI_SERVICE_PORT:-3007}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  analytics-service:
    build:
      context: .
      dockerfile: ./services/analytics-service/Dockerfile
    container_name: e-commerce-analytics-service
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "127.0.0.1:${ANALYTICS_SERVICE_PORT:-3008}:${ANALYTICS_SERVICE_PORT:-3008}"
    volumes:
      - ./logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${ANALYTICS_SERVICE_PORT:-3008}
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-ecommerce}
    networks:
      - default
      - nginx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${ANALYTICS_SERVICE_PORT:-3008}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  default:
    driver: bridge
  nginx-network:
    external: true
    name: ${NGINX_NETWORK_NAME:-nginx-network}

# Note: Notification and Logging microservices are in separate repositories:
# - ../notification-microservice (Port 3010)
# - ../logging-microservice (Port 3009)
# They should be started separately and connected to the nginx-network
