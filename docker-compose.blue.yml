services:
  frontend:
    build:
      context: .
      dockerfile: ./services/frontend/Dockerfile
    container_name: flipflop-service-frontend-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${FRONTEND_PORT:-3500}:3000
    depends_on:
      - api-gateway
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
      # Note: Do not mount source code in production - use standalone build output
      # - ./services/frontend:/app  # Removed: overwrites standalone build
      # - /app/node_modules  # Not needed with standalone
      # - /app/.next  # Not needed with standalone
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - API_URL=http://api-gateway:3011/api
      - NEXT_PUBLIC_API_URL=${API_URL:-https://flipflop.statex.cz/api}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 100M
          cpus: '0.5'
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
    container_name: flipflop-service-api-gateway-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${API_GATEWAY_PORT:-3511}:3011
    depends_on:
      - cart-service
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3011
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-flipflop}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 130M
          cpus: '0.5'
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3011/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  user-service:
    build:
      context: .
      dockerfile: ./services/user-service/Dockerfile
    container_name: flipflop-service-user-service-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${USER_SERVICE_PORT:-3504}:3004
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3004
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-flipflop}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 130M
          cpus: '0.5'
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3004/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  product-service:
    build:
      context: .
      dockerfile: ./services/product-service/Dockerfile
    container_name: flipflop-service-product-service-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${PRODUCT_SERVICE_PORT:-3502}:3002
    depends_on:
      - user-service
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
      - /srv/storagebox/statex/docker-volumes/flipflop/uploads:/app/uploads
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3002
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-flipflop}
      - CATALOG_SERVICE_URL=${CATALOG_SERVICE_URL:-http://catalog-microservice:3200}
      - WAREHOUSE_SERVICE_URL=${WAREHOUSE_SERVICE_URL:-http://warehouse-microservice:3201}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 130M
          cpus: '0.5'
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  order-service:
    build:
      context: .
      dockerfile: ./services/order-service/Dockerfile
    container_name: flipflop-service-order-service-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${ORDER_SERVICE_PORT:-3503}:3003
    depends_on:
      - supplier-service
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3003
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-flipflop}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL:-http://orders-microservice:3203}
      - WAREHOUSE_SERVICE_URL=${WAREHOUSE_SERVICE_URL:-http://warehouse-microservice:3201}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 130M
          cpus: '0.5'
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  cart-service:
    build:
      context: .
      dockerfile: ./services/cart-service/Dockerfile
    container_name: flipflop-service-cart-service-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${CART_SERVICE_PORT:-3509}:3009
    depends_on:
      - order-service
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3009
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-flipflop}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 150M
          cpus: '0.5'
        reservations:
          memory: 70M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3009/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  warehouse-service:
    build:
      context: .
      dockerfile: ./services/warehouse-service/Dockerfile
    container_name: flipflop-service-warehouse-service-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${WAREHOUSE_SERVICE_PORT:-3505}:3005
    depends_on:
      - product-service
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3005
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-flipflop}
      - WAREHOUSE_SERVICE_URL=${WAREHOUSE_SERVICE_URL:-http://warehouse-microservice:3201}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://guest:guest@statex_rabbitmq:5672}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 130M
          cpus: '0.5'
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3005/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

  supplier-service:
    build:
      context: .
      dockerfile: ./services/supplier-service/Dockerfile
    container_name: flipflop-service-supplier-service-blue
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${SUPPLIER_SERVICE_PORT:-3506}:3006
    depends_on:
      - warehouse-service
    volumes:
      - /srv/storagebox/statex/docker-volumes/flipflop/logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3006
      - DB_HOST=${DB_HOST:-db-server-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-dbadmin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-flipflop}
      - CATALOG_SERVICE_URL=${CATALOG_SERVICE_URL:-http://catalog-microservice:3200}
      - WAREHOUSE_SERVICE_URL=${WAREHOUSE_SERVICE_URL:-http://warehouse-microservice:3201}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL:-http://orders-microservice:3203}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://guest:guest@statex_rabbitmq:5672}
    networks:
      - nginx-network
    deploy:
      resources:
        limits:
          memory: 130M
          cpus: '0.5'
        reservations:
          memory: 50M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3006/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  default:
    driver: bridge
  nginx-network:
    external: true
    name: ${NGINX_NETWORK_NAME:-nginx-network}

# Note: External Shared Production Microservices (used by multiple applications):
# - ../notifications-microservice (Port 3368, Production: https://notifications.statex.cz)
# - ../logging-microservice (Port 3367, Production: https://logging.statex.cz)
# - ../database-server (PostgreSQL + Redis, Docker network: db-server-postgres, db-server-redis)
# - ../nginx-microservice (Reverse proxy, SSL termination, blue/green deployments)
# These are shared services managed separately and must be running before deploying this application.
# They should be started separately and connected to the nginx-network.

